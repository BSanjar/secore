name: Deploy to VPS via Docker Hub

on:
  push:
    branches:
      - test
      - prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Забираем код
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Игнорируем изменения в workflow файлах
          fetch-depth: 0
          path: repo
          
      # 2️⃣ Определяем переменные в зависимости от ветки
      - name: Set variables
        id: vars
        run: |
          if [ "${GITHUB_REF_NAME}" == "test" ]; then
            echo "IMAGE_TAG=sanjar883448/secore:test" >> $GITHUB_ENV
            echo "CONTAINER_NAME=secore_test" >> $GITHUB_ENV
            echo "PORT=8081" >> $GITHUB_ENV
          elif [ "${GITHUB_REF_NAME}" == "prod" ]; then
            echo "IMAGE_TAG=sanjar883448/secore:prod" >> $GITHUB_ENV
            echo "CONTAINER_NAME=secore_prod" >> $GITHUB_ENV
            echo "PORT=8080" >> $GITHUB_ENV
          fi

      # 3️⃣ Строим Docker образ
      - name: Build Docker image
        run: |
          docker build -t $IMAGE_TAG ./repo

      # 4️⃣ Логинимся в Docker Hub
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

      # 5️⃣ Пушим Docker образ
      - name: Push Docker image
        run: |
          docker push $IMAGE_TAG

      # 6️⃣ Деплой на сервер через SSH
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Останавливаем и удаляем старый контейнер
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true

            # Забираем новый образ
            docker pull $IMAGE_TAG

            # Запускаем контейнер на нужном порту
            docker run -d --name $CONTAINER_NAME -p $PORT:80 $IMAGE_TAG
