name: Deploy Branch to VPS via Docker Hub

on:
  push:
    branches:
      - test
      - prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Забираем код
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Генерируем уникальный тег образа
      - name: Set image tag
        run: |
          IMAGE_TAG="sanjar883448/secore:${GITHUB_REF_NAME}-${GITHUB_SHA::7}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "✅ Using image tag: $IMAGE_TAG"

      # 3️⃣ Собираем Docker образ
      - name: Build Docker image
        run: docker build -t $IMAGE_TAG .

      # 4️⃣ Логинимся в Docker Hub
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

      # 5️⃣ Публикуем образ
      - name: Push Docker image
        run: docker push $IMAGE_TAG

      # 6️⃣ Деплой на сервер
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: IMAGE_TAG,GITHUB_REF_NAME
          script: |
            set -e

            if [ "$GITHUB_REF_NAME" == "test" ]; then
              PORT=8081
              CONTAINER=secore_test
              ENVIRONMENT=Development
            elif [ "$GITHUB_REF_NAME" == "prod" ]; then
              PORT=8080
              CONTAINER=secore_prod
              ENVIRONMENT=Production
            fi

            echo "🚀 Deploying '$GITHUB_REF_NAME' build on port $PORT ..."
            echo "🧹 Cleaning up old containers and images..."

            docker stop $CONTAINER || true
            docker rm $CONTAINER || true
            docker image prune -af || true

            echo "⬇️ Pulling latest image: $IMAGE_TAG"
            docker pull $IMAGE_TAG

            echo "🧩 Starting new container..."
            docker run -d \
              --name $CONTAINER \
              --restart always \
              -p $PORT:80 \
              -e ASPNETCORE_ENVIRONMENT=$ENVIRONMENT \
              -e ASPNETCORE_URLS=http://+:80 \
              $IMAGE_TAG

            echo "✅ Deployment finished."
            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
